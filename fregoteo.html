<!doctype html>
<html>
<meta name="viewport" content="width=device-width, initial-scale=1">
<head>
  <meta charset="utf-8">
  <title>Fregoteo</title>
</head>
<body>
<script src="fregoteo.js"></script>
<script src="lib/pixi-4.5.3.min.js"></script>
<script>
function keyboard(keyCode) {
  var key = {};
  key.code = keyCode;
  key.isDown = false;
  key.isUp = true;
  key.press = undefined;
  key.release = undefined;
  //The `downHandler`
  key.downHandler = function(event) {
    if (event.keyCode === key.code) {
      if (key.isUp && key.press) key.press();
      key.isDown = true;
      key.isUp = false;
    }
    event.preventDefault();
  };

  //The `upHandler`
  key.upHandler = function(event) {
    if (event.keyCode === key.code) {
      if (key.isDown && key.release) key.release();
      key.isDown = false;
      key.isUp = true;
    }
    event.preventDefault();
  };

  //Attach event listeners
  window.addEventListener(
    "keydown", key.downHandler.bind(key), false
  );
  window.addEventListener(
    "keyup", key.upHandler.bind(key), false
  );
  return key;
}

//Use Pixi's built-in `loader` object to load an image
PIXI.loader
  .add("brut.png").add("net.png").add("galleda.png").add("maid2.png")
  .load(setup);

//This `setup` function will run when the image has loaded
function setup() {
	var habitacio=new Habitacio(4,4);
	j=new Jugador(habitacio,new Posicio(0,0));
	g=new Galleda(new Posicio(2,2),20);
	joc=new Joc(habitacio,j,g)
	joc.start();
}


function Joc(habitacio,jugador,galleda) {
	var self = this;
	self.habitacio=habitacio;
	self.jugador=jugador;
	self.galleda=galleda;
	self.acabat=false;

	self.actualitzaMarcador=function () {
		document.getElementById("fregona").innerHTML=self.jugador.aiguaFregona
		document.getElementById("galleda").innerHTML=self.galleda.aigua
		document.getElementById("brutes").innerHTML=self.habitacio.rajolesBrutes()
	}

	self.tractaAccio=function() {
		console.log("accio")
		if (self.galleda.estaAgafada()) {
			console.log("deixa")
			self.jugador.deixaGalleda(self.galleda);
			return;
		}
		if (self.jugador.estaSobre(self.galleda) && !self.galleda.estaAgafada()) {
			self.jugador.agafaGalleda(self.galleda)
			self.jugador.mullaFregona(self.galleda)
			return;
		}
		console.log("frego")
		self.jugador.frega()		
	}

    self.start=function() {
		var left = keyboard(37),
				up = keyboard(38),
				right = keyboard(39),
				down = keyboard(40),
				space = keyboard(32);
		left.press = function() {self.jugador.vesCap(-1,0)};
		up.press = function() {self.jugador.vesCap(0,-1)};
		down.press = function() {self.jugador.vesCap(0,1)};
		right.press = function() {self.jugador.vesCap(1,0)};
		space.press = function() {self.tractaAccio()};

		self.stage = new PIXI.Container(),
    	self.renderer = PIXI.autoDetectRenderer(256, 256);
		document.body.appendChild(self.renderer.view);
		
		self.displayHabitacio(self.habitacio);
		self.displayJugador(self.jugador);
		self.displayGalleda(self.galleda);

		self.bucle();
	}		

	self.bucle= function() {
		self.updateHabitacio(self.habitacio);
		self.updateJugador(self.jugador);
		self.updateGalleda(self.galleda);
		self.renderer.render(self.stage);
		self.habitacio.pas();
		self.jugador.pas();
		self.actualitzaMarcador()
		self.acabatBe=(self.habitacio.estaSeca() && self.habitacio.rajolesBrutes()==0)
		self.acabatMalament=(self.habitacio.rajolesBrutes()>0 && self.jugador.aiguaFregona==0 && self.galleda.aigua==0)
		if (!(self.acabatBe||self.acabatMalament)) {
			window.requestAnimationFrame(self.bucle);
		} else {
			if (self.acabatBe) alert("Habitaci√≥ neta!")
			if (self.acabatMalament) alert("Se t'ha acabat l'aigua...")
		}
	}

    self.displayJugador=function() {			
		self.cat=new PIXI.Sprite(PIXI.loader.resources["maid2.png"].texture);		
		self.stage.addChild(self.cat);				
	}

    self.displayGalleda=function() {			
    	var sprite=new PIXI.Sprite(PIXI.loader.resources["galleda.png"].texture);
    	self.galleda.sprite=sprite;
		self.stage.addChild(sprite);
	}

    self.updateJugador=function(jugador) {			
		this.cat.x=jugador.x
		this.cat.y=jugador.y
	}

    self.updateGalleda=function(galleda) {	
    	if (galleda.estaAgafada()) {
			galleda.sprite.x=galleda.agafadaPer.x;
			galleda.sprite.y=galleda.agafadaPer.y-10;
		} else {
			galleda.sprite.x=galleda.posicio.coordenadaX();
			galleda.sprite.y=galleda.posicio.coordenadaY();
		}
	}

	self.tractaClick=function(event) {
		var rajola=event.target.rajola;
		if (self.jugador.estaSobre(rajola)) {
			self.tractaAccio();
		} else {
			if (rajola.posicio.fila==self.jugador.posicio.fila || rajola.posicio.columna==self.jugador.posicio.columna) {
				self.jugador.vesCasella(rajola.posicio);
			}
		}
	}

	self.displayHabitacio=function(habitacio) {
		var rajoles=habitacio.llistaRajoles
		for (i in rajoles) {
			var rajola=rajoles[i]
			var sprite = new PIXI.Sprite();
			sprite.x=rajola.posicio.coordenadaX();
			sprite.y=rajola.posicio.coordenadaY();
			sprite.interactive=true;
			sprite.rajola=rajola;
			sprite.on('pointerdown',self.tractaClick);			
			rajola.sprite=sprite;			
			self.stage.addChild(sprite);
		}
	}		

	self.updateHabitacio=function(habitacio) {
		var colors=['F','E','C','B','A','9','8','7','6','5'];
		var rajoles=habitacio.llistaRajoles
		for (i in rajoles) {
			var f="net.png";
			if (rajoles[i].estaBruta()) f="brut.png";
			rajoles[i].sprite.setTexture(PIXI.loader.resources[f].texture);
			var a=colors[rajoles[i].molla];
			var tint="0x"+a+a+a+a+"FF"
			rajoles[i].sprite.tint=tint;
		}
	}		


}

</script>
<p>Fregona: <span id="fregona"></span> Galleda: <span id="galleda"></span> Brutes: <span id="brutes"></span></p>
</body>
</html>
